# دراسة استراتيجية مواقيت الصلاة — API أم تخزين محلي؟

> تاريخ: 16 شباط 2026  
> الهدف: تحديد أفضل طريقة لجلب وحفظ مواقيت الصلاة بما يتوافق مع باقي ميزات التطبيق

---

## 1. وصف الميزات الحالية واعتمادها على الشبكة

| الميزة | يعمل بدون نت؟ | التفاصيل |
|--------|---------------|----------|
| **تسجيل الصلاة** | نعم | يُحفظ محلياً في SQLite، يُرفع لـ Firestore عند عودة الاتصال |
| **عرض مواقيت الصلاة** | نعم (مع كاش) | حالياً: Adhan يحسب محلياً → لا يحتاج نت. مع API: يحتاج جلب مرة واحدة على الأقل |
| **الإشعارات المحلية** | نعم | تُجدول على الجهاز (flutter_local_notifications)، لا تحتاج نت بعد الجدولة |
| **قبلة** | نعم | الحساب محلي (الانحراف من GPS) |
| **المزامنة** | لا | تحتاج نت لرفع السجلات إلى Firestore |
| **تسجيل الدخول / التسجيل** | لا | يعتمد على Firebase Auth |
| **البروفايل** | جزئي | Firestore له كاش أوفلاین، لكن أول تحميل يحتاج نت |
| **Reverse Geocoding (اسم المدينة)** | لا | جلب اسم المدينة من الإحداثيات يحتاج API خارجي |

---

## 2. سيناريوهات الاستخدام

### أ) مستخدم متصل غالباً
- يفتح التطبيق وهو متصل.
- يغلق التطبيق ويبقى متصل (أو ينقطع لفترة قصيرة).
- **النتيجة:** أي استراتيجية تعمل جيداً.

### ب) مستخدم ينقطع عنه النت أحياناً
- يفتح التطبيق في المترو أو منطقة ضعيفة الإرسال.
- يريد تسجيل الصلاة وهو أوفلاین.
- **النتيجة:** يحتاج مواقيت اليوم على الأقل من الكاش حتى يعرف ماذا يسجّل.

### ج) مستخدم يسافر
- يغيّر المدينة/الدولة.
- قد يكون أوفلاین عند الوصول.
- **النتيجة:** إذا كنّا نحفظ شهر كامل للموقع الحالي، لن يجد مواقيت الموقع الجديد حتى يتصل.

---

## 3. خيارات الاستراتيجية

### الخيار أ: جلب يومي من API + كاش ليوم واحد (أو يومين)

**الآلية:**
- عند الاتصال: جلب مواقيت اليوم (وغداً للفجر بعد العشاء) من Aladhan API.
- حفظها محلياً في SQLite (كما هو حالياً).
- عند الانقطاع: استخدام الكاش إن وُجد.

**إيجابيات:**
- بسيط، طلبات API قليلة.
- حجم تخزين صغير.
- منطقي مع التصميم الحالي للكاش.

**سلبيات:**
- أول فتح في موقع جديد بدون نت = لا مواقيت حتى يتصل.
- انقطاع طويل = يوم واحد فقط من المواقيت، بعدها لا شيء.

---

### الخيار ب: جلب شهر كامل + كاش لشهر

**الآلية:**
- عند الاتصال: جلب مواقيت الشهر من Aladhan Calendar API (`/v1/calendar`).
- حفظها محلياً في SQLite.
- عند الانقطاع: قراءة المواقيت من الكاش.

**إيجابيات:**
- أفضل تجربة أوفلاین: شهر كامل من المواقيت.
- طلب واحد للشهر بدلاً من 30 طلب يومي.
- منطقي للمستخدم الذي يفتح التطبيق يومياً دون اتصال مستمر.

**سلبيات:**
- تخزين أكبر (حوالي 30 يوم × 6 صلوات × بيانات خفيفة ≈ بضعة كيلوبايت).
- تغيير الموقع يحتاج جلب شهر جديد.
- يجب التعامل مع تغيير الشهر (نهاية الشهر → جلب الشهر التالي).

---

### الخيار ج: هجين — API عند الاتصال + Adhan كمصدر احتياطي أوفلاین

**الآلية:**
- عند الاتصال: استخدام Aladhan API (أفضل طرق حسابات رسمية حسب الدولة).
- عند الانقطاع وغياب الكاش: استخدام Adhan محلياً (كما الآن).

**إيجابيات:**
- لا يوجد حالة "لا مواقيت" — دائماً هناك مصدر.
- نستخدم الطريقة الأفضل (API) عند الإمكان، ونتحوط بالأوفلاین.

**سلبيات:**
- الحفاظ على مسارين: API و Adhan.
- اختلاف بسيط محتمل بين الحسابين (غالباً دقائق قليلة).

---

### الخيار د: API فقط، بدون ضمان أوفلاین

**الآلية:**
- جلب المواقيت من API فقط.
- كاش يومي أو لا كاش.

**إيجابيات:**
- أبسط تنفيذ.
- مواقيت موحدة ومضمونة من مصدر واحد.

**سلبيات:**
- بدون نت = لا مواقيت (إلا إذا وُجد كاش سابق).
- تجربة سيئة في المترو، الطائرة، المناطق الريفية.

---

## 4. هل كل الميزات تحتاج نت؟

**الجواب: لا.**

من تحليل الكود:
- تسجيل الصلاة يعمل أوفلاین (SQLite + صف مزامنة).
- عرض المواقيت (من الكاش) والإشعارات المجدولة يعملان بدون نت.
- القبلة محسوبة محلياً.

**الميزات التي تحتاج نت:**
- تسجيل الدخول / التسجيل.
- المزامنة مع Firestore.
- جلب اسم المدينة (Reverse Geocoding).
- جلب مواقيت جديدة من API (في حال الاعتماد على API).

لذلك فكرة "كل شيء يحتاج نت" غير دقيقة — التطبيق مصمم لأوفلاین جزئي. الفارق الوحيد إذا انتقلنا إلى API هو: هل نحافظ على القدرة على عرض المواقيت بدون نت أم لا.

---

## 5. التوصية

بناءً على:
1. دعم التطبيق الحالي للعمل الجزئي بدون نت.
2. أهمية المواقيت لتسجيل الصلاة ولجدولة الإشعارات.
3. رغبتك بدقة المواقيت عبر Aladhan وطريقة مناسبة لكل دولة.

### التوصية المختصرة: **الخيار ب (شهر كامل)** أو **الخيار ج (هجين)** حسب أولوياتك.

| الأولوية | الاختيار | السبب |
|----------|----------|-------|
| أفضل تجربة أوفلاین | **الخيار ب** | شهر كامل من المواقيت بدون نت بعد جلب واحد |
| ضمان عدم غياب المواقيت أبداً | **الخيار ج** | وجود Adhan كمصدر احتياطي عند غياب الكاش |
| البساطة و"كل شيء يحتاج نت" | **الخيار د** | أبسط كود، لكن أسوأ تجربة أوفلاین |

### توصية عملية للتنفيذ

- البدء بـ **الخيار ب (شهر كامل)** لأن:
  - Aladhan يدعم `/v1/calendar` بطلب واحد للشهر.
  - جدول الكاش الحالي يدعم تخزين مواقيت متعددة (يمكن تمديده بسهولة).
  - يحافظ على تجربة أوفلاین قوية مع ميزة تسجيل الصلاة والإشعارات.

- إذا أردت حماية إضافية في حال فشل الجلب أو عدم وجود كاش أبداً، يمكن إضافة **مصدر احتياطي (Adhan محلي)** لاحقاً ليصبح النموذج أقرب للخيار ج.

---

## 6. ملخص سريع

| السؤال | الإجابة |
|--------|---------|
| هل تخزين شهر مفيد؟ | نعم — يعطي أفضل تجربة أوفلاین لمعظم المستخدمين |
| هل كل الميزات تحتاج نت؟ | لا — تسجيل الصلاة والإشعارات والقبلة تعمل أوفلاین |
| ما الأفضل للأردن؟ | استخدام method 23 (Ministry of Awqaf, Jordan) من Aladhan |
| ما مدى تعقيد جلب شهر؟ | طلب واحد `/v1/calendar` مع latitude, longitude, month, year, method |

---

## 7. التنفيذ (تم)

الخيار ج (هجين) مُنفَّذ:

- **عند الاتصال:** جلب شهر من Aladhan API، حفظ محلياً
- **عند الانقطاع أو فشل API:** استخدام الكاش؛ إن لم يُوجد → Adhan محلي
- **جلب مسبق:** قبل 5 أيام من نهاية الشهر → جلب الشهر التالي
- **الدولة → Method:** خريطة في `aladhan_constants.dart` (الأردن = 23)
