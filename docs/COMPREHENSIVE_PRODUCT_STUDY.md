# دراسة شاملة لمنتج تطبيق صلاة

وثيقة لمراجعة المنتج، تجربة المستخدم، الإشعارات، العائلة، المواقيت، القضاء، والمزامنة — تمهيداً لأي إعادة هندسة أو إعادة بناء.

---

## 1. الأصوات في الإعدادات (Sounds in Settings)

### الوضع الحالي
- **ما تم إلغاؤه**: الأذان الكامل (full adhan) — التطبيق لا يشغّل أذاناً كاملاً.
- **ما يعمل فعلياً**: 
  - **مبشرة اقتراب الصلاة**: صوت قصير قبل دخول وقت الصلاة (دقائق قبل).
  - **عند وقت الأذان**: تكبير فقط (takbeer) وليس أذاناً كاملاً.

- في الإعدادات يوجد خيار **"طريقة الصوت"** بثلاث قيم:
  - `sound_adhan` (مترجم: أذان / Adhan)
  - `sound_vibrate` (اهتزاز)
  - `sound_silent` (صامت)

### المشكلة
التسمية **"أذان"** مضلّلة: المستخدم يظن أن الخيار يتحكم بأذان كامل، بينما التطبيق يتحكم فقط بـ:
- صوت الاقتراب (approach sound)
- التكبير عند وقت الصلاة (takbeer)

### التوصية
- **تغيير التسميات** حسب الواقع:
  - عربي: مثلاً "صوت التكبير" / "صوت عند الصلاة" بدل "أذان".
  - إنجليزي: "Prayer sound" أو "Sound at prayer time" بدل "Adhan".
- أو توحيد المفهوم: "صوت" / "اهتزاز" / "صامت" مع وصف قصير يوضح أن المقصود هو التنبيه عند وقت الصلاة (تكبير/مبشرة وليس أذاناً كاملاً).

---

## 2. البريد (Report Bug / Suggest Feature / Contact Us)

### الوضع الحالي
- نصوص الإيميل **ثابتة بالإنجليزي** في الكود:
  - Subject: `'Report a Bug - Salah App'` و `'Feature Suggestion - Salah App'`
  - Body: `'Please describe the bug below:\n'` و `'I would like to suggest a new feature:\n'`

### التوصية
- **ربط النصوص بلغة التطبيق** (مثلاً `Get.locale`):
  - **عربي**: عنوان مثل "تقرير مشكلة - تطبيق صلاة"، وجسم مثل "أعطنا ملاحظتك / صف المشكلة أدناه".
  - **إنجليزي**: "Report a Bug - Salah App" و "Give your report / Describe the issue below".
- يمكن وضع المفاتيح في `ar_translations` و `en_translations` واستخدام `.tr` لـ subject و body عند فتح `mailto`.

---

## 3. تاريخ الميلاد والجنس (Birth Date & Gender)

### الوضع الحالي
- **تسجيل ببريد إلكتروني**: يتم جمع الاسم، البريد، كلمة المرور، ثم في **إعداد البروفايل** (Profile Setup) يُطلب الاسم وتاريخ الميلاد والجنس.
- **تسجيل دخول بقوقل**: قوقل يعطي (displayName, email, photoURL) فقط — **لا يعطي تاريخ ميلاد ولا جنس**.

### أين تُستخدم البيانات حالياً
- **UserModel**: يحفظ `birthDate` و `gender`.
- **العمر**: يوجد في الموديل حساب لعمر المستخدم (للعرض أو منطق مستقبلي).
- **العائلة**: عند إضافة "طفل" يُطلب اسم وتاريخ ميلاد وجنس — منطقياً للأطفال الذين لا يملكون حساباً.

### التوصية
- **من قوقل**: لا يمكن الحصول على تاريخ الميلاد أو الجنس — إما نترك الحقول اختيارية أو نطلبها مرة واحدة عند أول استخدام لِميزة تحتاجها (مثلاً إحصائيات عمرية أو عائلة).
- **من تسجيل البريد**: الإبقاء على جمع الاسم؛ تاريخ الميلاد والجنس يمكن جعلهما **اختياريين** إلا إذا كانت ميزة معينة تعتمد عليهما (مثلاً "إضافة طفل" تحتاج تاريخ ميلاد الطفل).
- توثيق واضح في المنتج: "لماذا نطلب تاريخ الميلاد؟" (مثلاً: للعمر، أو للعائلة فقط).

---

## 4. طريقة اختيار مواقيت الصلاة في الإعدادات

### الوضع الحالي
- **موجودة** في الإعدادات:
  - **طريقة الحساب** (Calculation Method): Muslim World League, Egyptian, Karachi, Umm Al-Qura, Dubai, Qatar, Kuwait, Singapore, Turkey, Tehran, North America, Moon Sighting Committee.
  - **المذهب** (Madhab): Shafi'i, Hanafi (لحساب العصر).
  - **ضبط يدوي للمواقيت** (Prayer Adjustment): شاشة تعديل إزاحة كل صلاة بدقائق.

- الحساب يتم عبر مكتبة **adhan** (Dart) وخدمة **PrayerTimeService** مع دعم الموقع والمدينة الافتراضية.

### التوصية
- المراجعة من ناحية **وضوح الواجهة**: هل المستخدم العادي يفهم "طريقة الحساب" vs "المذهب"؟
- إضافة **نص مساعد قصير** (عربي/إنجليزي) يشرح تأثير كل خيار إن أمكن.
- التأكد أن ضبط الإزاحة (دقائق ±) واضح ولا يتجاوز حدوداً معقولة (مثلاً ±60 دقيقة).

---

## 5. الإشعارات وصفحة العائلة والربط بينهما

### ملاحظاتك (مختصرة)
- هل الإشعارات + صفحة العائلة + طريقة الربط مقتنع بها؟
- رغبة في: عند صلاة الابن → إشعار للأب (وظائف مثل هذه).
- تجربة مستخدم: مقارنة مع إنستغرام/تيليجرام (فتح محادثة من الشريط، قوائم، إلخ) — نريد تجربة "فخمة وسهلة".
- صفحة العائلة كبيرة لكن المحتوى الفعلي (إضافة طفل، كود، إشعارات) قليل — تحتاج دراسة كاملة.
- أسئلة: مجموعات متعددة؟ التحكم بجميع الإشعارات؟ دقة المواقيت؟ الساعة والألوان (تأخر، نبض العائلة، تصفير يومي)؟ هل نقدّم فعلاً تجربة سلسة لأداء الصلاة؟

### تقييم مبدئي
- **الإشعارات ↔ المواقيت**: الربط موجود (إشعار اقتراب، إشعار وقت الصلاة، تذكير)، لكن وضوح "ماذا يتحكم بماذا" في الإعدادات يحتاج مراجعة (انظر نقطة الأصوات).
- **العائلة ↔ الإشعارات**: يوجد إشعار تشجيع وإشعار "نبض العائلة" واحتفال عند اكتمال الصلاة — لكن **"عند صلاة الابن → إشعار للأب"** يحتاج تأكيد في الكود والمنتج (FCM / مواضيع العائلة).
- **صفحة العائلة**: المنطق الحالي (عائلة واحدة، كود دعوة، إضافة طفل، تشجيع، تسجيل صلاة لعضو) يمكن توسيعه لاحقاً (مجموعات متعددة، تحكم مركزي بالإشعارات) — وهذا يحتاج **مواصفات مرحلة ثانية** وليس بالضرورة إعادة بناء كاملة من الصفر.
- **الساعة والألوان**: فكرة استخدام الألوان لتمييز الحالة (تأخر، نبض جيد، تصفير يومي) جيدة — تحتاج توحيد في الواجهة وتوثيق "دليل ألوان" للمستخدم إن لزم.

### التوصية
- إعداد **مواصفات مرحلة 2 للعائلة والإشعارات** تشمل:
  - سيناريوهات واضحة: "ابن صلّى → إشعار للأب"، "تذكير للأبناء"، "احتفال عند اكتمال اليوم".
  - هل ندعم أكثر من مجموعة (عائلة / أصدقاء) وما الإشعارات لكل منها.
  - تصميم تنقل وواجهة (قوائم، شريط سفلي، PopupMenu) مستوحى من تطبيقات مرجعية مع الحفاظ على بساطة التطبيق.
- مراجعة **واجهة صفحة العائلة** (تقليل الحجم البصري، ترتيب: إضافة طفل، الكود، الإشعارات، النبض) دون تغيير المنطق الخلفي في البداية.

---

## 6. القضاء / الصلوات التي لم تُسجّل (Qada)

### الوضع الحالي
- **اكتشاف القضاء**: `QadaDetectionService` يبني قائمة صلوات اليوم/أمس غير المسجّلة (`allPendingQada`).
- **عرض التلميح**: في `DashboardController` بعد تحميل الداشبورد يتم استدعاء `_maybeShowQadaHint()`:
  - إذا وجدت صلوات غير مسجّلة ولم يُعرض التلميح اليوم → يظهر **حوار** بعنوان "صلوات لم تُسجّل" وزر **"تعويض"**.
  - عند الضغط على "تعويض" → استدعاء `QadaReviewBottomSheet.show()`.
- **البوتوم شيت**: يعرض قائمة الصلوات غير المسجّلة ويوفّر "صليتها" / "فاتتني" / "صليت الكل".

### مشكلة محتملة (لم تُسجّل — ما صار شيء)
- إذا كان المستخدم **لا يرى الحوار أصلاً**: قد يكون التوقيت (مثلاً عرض التلميح مرة واحدة يومياً وتاريخ آخر تلميح محفوظ)، أو شرط `allPendingQada.isEmpty` يتحقق مبكراً قبل تحديث الخدمة.
- إذا كان المستخدم **يضغط تعويض ولا يفتح البوتوم شيت**: `QadaReviewBottomSheet.show()` يخرج فوراً إذا `allPendingQada.isEmpty` — قد يكون هناك توقيت بين إغلاق الحوار وتشغيل البوتوم شيت فتتغيّر القائمة (أقل احتمالاً)، أو مشكلة في تسجيل الخدمات/Get.
- **عدم وضوح المسار**: ربما المستخدم لا يعرف أين يفتح "قضاء الصلوات" إذا فاته الحوار — لا يوجد زر ثابت واضح في الواجهة لـ "تعويض الصلوات".

### التوصية
- **زر واضح ودائم** في الداشبورد أو القائمة: "صلوات لم تُسجّل" / "تعويض" يفتح مباشرة `QadaReviewBottomSheet.show()` (أو شاشة قضاء كاملة إن وُجدت).
- **تحسين التوقيت**: التأكد أن `_maybeShowQadaHint` تُستدعى بعد أن تكون `QadaDetectionService` قد حدّثت `allPendingQada` (مثلاً بعد استماع لـ prayer times و todayLogs).
- **سرد المستخدم**: إذا قال "كبست تعويض ما صار شيء" — إضافة تسجيل (log) عند فتح الحوار وعند الضغط تعويض وعند فتح البوتوم شيت لمعرفة أين ينقطع المسار.
- **نسخ واجهة المستخدم**: التأكد أن النصوص (تعويض، صليتها، فاتتني، صليت الكل) واضحة ومترجمة في الوضعين عربي/إنجليزي.

---

## 7. المزامنة والاتصال (Offline / Sync)

### الوضع الحالي
- يوجد مؤشر اتصال (ConnectionStatusIndicator) وتخزين محلي (SQLite / DatabaseHelper) وFirestore.
- السجلات يمكن أن تُحفظ محلياً ثم تُرفع لاحقاً (pending sync).

### التوصية
- توثيق **سلوك التطبيق عند انقطاع النت**: أي إجراءات تعمل دون نت؟ (تسجيل الصلاة، عرض المواقيت، فتح شاشة القضاء؟) وأيها يحتاج اتصالاً؟
- توثيق **سياسة المزامنة**: متى نرفع السجلات؟ متى نعرض "في انتظار المزامنة" للمستخدم؟
- مراجعة أن **تعويض الصلوات** يعمل مع البيانات المحلية عند عدم وجود اتصال إن كان ذلك مطلوباً في المنتج.

---

## 8. خارطة طريق مقترحة للدراسة والتنفيذ

1. **تحسينات سريعة (بدون إعادة بناء)**  
   - تصحيح تسميات الأصوات (أذان → صوت التكبير/صوت عند الصلاة).  
   - توطين نصوص الإيميل (تقرير مشكلة / اقتراح ميزة) حسب لغة التطبيق.  
   - زر واضح لـ "تعويض الصلوات" + تحسين توقيت ومسار فتح البوتوم شيت.  
   - توثيق استخدام تاريخ الميلاد والجنس واختياريتهما حسب نوع التسجيل.

2. **مواصفات مرحلة 2 — العائلة والإشعارات**  
   - سيناريوهات: ابن صلّى → إشعار للأب؛ تذكير؛ احتفال.  
   - دعم مجموعات متعددة أم لا؛ تحكم مركزي بالإشعارات.  
   - تحسين تنقل الواجهة (قوائم، شريط، قوائم منبثقة) دون تعقيد زائد.

3. **مراجعة تجربة المستخدم**  
   - الداشبورد: الساعة، الألوان، النبض، التصفير اليومي.  
   - صفحة العائلة: تبسيط التخطيط وترتيب المحتوى (إضافة طفل، كود، إشعارات).  
   - دقة المواقيت ووضوح طريقة الحساب في الإعدادات.

4. **المزامنة وال offline**  
   - توثيق السلوك الحالي ووضع سياسة واضحة للمزامنة وعرض الحالة للمستخدم.

هذه الوثيقة يمكن أن تكون أساساً لاجتماع تخطيط أو لوثيقة مواصفات تفصيلية (مثلاً لكل ميزة على حدة) أو لإعادة بناء صفحة العائلة لاحقاً بعد استقرار المتطلبات.
