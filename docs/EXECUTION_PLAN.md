# خطة التنفيذ — قُرب (مرتبة حسب الأولوية)

هذه الخطة تربط [MASTER_SPEC_NOTIFICATIONS_AND_ENGAGEMENT.md](MASTER_SPEC_NOTIFICATIONS_AND_ENGAGEMENT.md) و [DEVELOPMENT_PLAN.md](DEVELOPMENT_PLAN.md) بمهام تنفيذية قابلة للتتبع. نفّذ بالترتيب ما أمكن.

---

## المرحلة 1 — تجربة المستخدم والحالات الحدية (Edge Cases)

### 1.1 الموقع
- [x] استخدام مدينة/موقع افتراضي عند فشل الموقع (مكة أو آخر مدينة محفوظة) — *موجود في LocationService*
- [x] **عرض رسالة واضحة عند استخدام الموقع الافتراضي**: بانر تحت المحتوى مع `location_default_hint` وقابل للضغط للانتقال لشاشة اختيار المدينة
- [x] شاشة اختيار المدينة مفتوحة من الـ Dashboard (الضغط على اسم المدينة في AppBar) ومن الإعدادات

### 1.2 الإشعارات (صلاحيات النظام)
- [x] **عند رفض صلاحيات الإشعارات**: عرض رسالة واحدة (مرة واحدة): "لتفعيل تذكير الصلاة، يرجى السماح بالإشعارات من إعدادات التطبيق" مع زر يفتح إعدادات التطبيق
- [x] عدم إعادة إظهار الطلب — استخدام علم `notification_permission_hint_shown` في Storage

### 1.3 الأوفلاين والمزامنة
- [x] **عند حفظ صلاة بدون إنترنت**: إظهار Toast "تم الحفظ. سيتم المزامنة عند عودة الاتصال." (`saved_will_sync_later`) من Dashboard، Qada، MissedPrayers، والإشعار
- [x] **عند فشل المزامنة**: تسجيل الخطأ عبر `AppLogger` وإظهار Toast "فشل المزامنة. سيتم إعادة المحاولة تلقائياً." (`sync_failed_retry`)
- [x] مؤشر الاتصال (ConnectionStatusIndicator) مفعّل في الـ Dashboard

---

## المرحلة 2 — الإشعارات (جدولة وإلغاء ومصدر واحد)

### 2.1 مصدر واحد للجدولة
- [x] أزرار إشعار "صليت" و "لاحقاً" — *موجودة في SmartNotificationService*
- [x] إلغاء التذكير عند تسجيل الصلاة — *منطق في NotificationService/Dashboard*
- [x] **توحيد الجدولة**: جدولة الأذان والتذكير من DashboardController مع احترام إعداد كل صلاة (fajr/dhuhr/asr/maghrib/isha) وثابت التأخير `ApiConstants.prayerReminderDelayMinutes`
- [x] تذكير بعد 30 دقيقة: موثّق في ApiConstants ومستخدم في NotificationService ومراجعة يومية

### 2.2 إعدادات الإشعارات (واجهة واحدة)
- [x] ربط المفاتيح (notifications_enabled, adhan_notifications_enabled, fajr/dhuhr/asr/maghrib/isha, reminder, family_notification, notification_sound_mode) بواجهة الإعدادات (شاشة الإشعارات من Settings)
- [x] تذكير بعد X دقيقة: ثابت 30 في `ApiConstants.prayerReminderDelayMinutes` ومستخدم في مكان واحد عند الجدولة

---

## المرحلة 3 — العائلة والتفاعل الاجتماعي

### 3.1 نبض العائلة (Pulse)
- [x] تيار أحداث العائلة (من صلى، من شجّع) — *موجود في FamilyService/FamilyPulseEvent*
- [x] عرض قسم "نبض العائلة" في صفحة العائلة (بين الملخص والأعضاء)
- [x] **تجربة واجهة**: وقت نسبي، أيقونات مميزة، ألوان حسب النوع، حدود وخلفيات

### 3.2 إشعارات عائلية
- [ ] **عند تسجيل عضو لصلاة**: إذا كان خيار "إشعارات العائلة" مفعّلاً، إرسال إشعار لأعضاء العائلة (مثلاً "أحمد صلّى العصر"). **يتطلب FCM وربما دالة Cloud أو تكامل من الجهاز مع Firestore**
- [ ] احترام إعداد "إشعارات العائلة" لكل مستخدم (عدم إرسال إن أوقفها)

### 3.3 تشجيع
- [x] زر "شجّعه" في صفحة العائلة — *موجود*
- [ ] **إشعار للمُشجَّع**: عند الضغط على "شجّعه"، إرسال إشعار للمُشجَّع (إن مُفعّل) — **يتطلب FCM أو إشعار محلي حسب البنية**

---

## المرحلة 4 — القضاء (Qada) والتحسينات الإضافية

### 4.1 اكتشاف الصلوات الفائتة
- [x] QadaDetectionService يتحقق من صلوات لم تُسجّل — *موجود*
- [x] **تذكير قضاء**: عند فتح التطبيق ووجود صلوات فائتة، عرض حوار مرة واحدة في اليوم: "لديك صلوات لم تُسجّل — هل تريد تعويضها؟" مع فتح شاشة مراجعة القضاء (QadaReviewBottomSheet)

### 4.2 إعدادات وتجربة أول استخدام
- [x] ترتيب Onboarding: ترحيب → مميزات → صلاحيات (موقع، إشعارات) → إعداد الملف الشخصي — *موجود في OnboardingController*
- [x] عند رفض الموقع: عرض تلميح "يمكنك اختيار المدينة يدوياً من الإعدادات لاحقاً" (`location_denied_hint`) دون منع إكمال التسجيل

---

## المرحلة 5 — الجودة التقنية والمحتوى

### 5.1 تسجيل الأخطاء
- [x] استخدام `AppLogger.error`/`AppLogger.warning` في catch داخل PrayerRepository, UserRepository, FamilyService
- [x] رسائل المستخدم عبر `AppFeedback`/`errorMessage` مفهومة (بدون تفاصيل تقنية)

### 5.2 تقليل حجم الملفات
- [ ] فصل widgets كبيرة من `dashboard_screen.dart` و `family_dashboard_screen.dart` إلى ملفات منفصلة — *اختياري لاحقاً*
- [ ] إن تجاوز Controller 400 سطر، استخراج منطق إلى UseCase أو Service

### 5.3 ترجمة الرسائل
- [x] إضافة مفاتيح الترجمة: `notification_permission_hint`, `saved_will_sync_later`, `sync_failed_retry`, `qada_hint_title`, `qada_hint_message`, `qada_review_action`, `location_denied_hint`

---

## ملخص الحالة الحالية

| البند | الحالة |
|-------|--------|
| إشعارات بأزرار صليت/لاحقاً | منفّذ |
| Pulse العائلة وعرضه | منفّذ |
| تسجيل صلاة عن طفل + تشجيع (من الواجهة) | منفّذ |
| موقع افتراضي (مكة) عند فشل الموقع | منفّذ |
| اختيار مدينة يدوياً | منفّذ |
| بانر/رسالة واضحة عند استخدام موقع افتراضي | منفّذ |
| Toast عند حفظ أوفلاين "سيتم المزامنة لاحقاً" | منفّذ |
| تلميح صلاحيات الإشعارات (مرة واحدة) + فتح الإعدادات | منفّذ |
| فشل المزامنة: AppLogger + Toast + مؤشر الاتصال | منفّذ |
| توحيد جدولة الإشعارات (per-prayer + ثابت 30 د) | منفّذ |
| إعدادات الإشعارات (كل المفاتيح في الواجهة) | منفّذ |
| تذكير قضاء عند فتح التطبيق (مرة في اليوم) | منفّذ |
| تلميح رفض الموقع (اختيار مدينة لاحقاً) | منفّذ |
| AppLogger في Repositories و FamilyService | منفّذ |
| إشعار عائلي "فلان صلى" | مطلوب (يعتمد FCM/backend) |
| إشعار تشجيع للمُشجَّع | مطلوب (يعتمد FCM) |

---

**كيفية الاستخدام:** ضع علامة `[x]` عند إكمال كل بند، وحدّث "ملخص الحالة الحالية" دورياً. راجع [MASTER_SPEC](MASTER_SPEC_NOTIFICATIONS_AND_ENGAGEMENT.md) للتفاصيل النظرية و [ARCHITECTURE](ARCHITECTURE.md) للبنية التقنية.
