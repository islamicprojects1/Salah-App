# دراسة شاملة: أذونات الموقع والإشعارات في Onboarding

## 1. الوضع الحالي

### صفحة الأذونات (Permissions Page)
- تظهر بطاقتان: الموقع، الإشعارات
- زر واحد "منح الأذونات" يطلب الموقع أولاً ثم الإشعارات بشكل متسلسل
- لا يمكن النقر على كل بطاقة لطلب إذنها بشكل منفصل

### فحص حالة الأذونات
- `_checkPermissionsStatus` يفحص `_locationService.hasLocation` للموقع
- **مشكلة**: `hasLocation` = true عندما يكون لدينا إحداثيات (حتى مكة الافتراضية!)
- الإشعارات: لا يُفحص حالتها عند فتح الصفحة، تبقى false حتى ينقر المستخدم

### LocationService.init()
- يستدعي `getCurrentLocation()` في الخلفية بعد التشغيل
- **مشكلة**: إذا رفض المستخدم الموقع في Onboarding، سيُطلب منه مرة ثانية عند كل تشغيل!

### زر "استخدم موقع الجهاز" (Select City Screen)
- يستدعي `useCurrentLocation()` → `LocationService.getCurrentLocation()`
- **مشكلة محتملة**: إذا فشل الطلب بصمت أو لم يُعرض feedback، يبدو أن الزر "لا يعمل"

---

## 2. الحلول المُطبّقة

### أ. جعل بطاقات الأذونات قابلة للنقر
- كل بطاقة تطلب إذنها عند النقر عليها
- الزر الرئيسي يطلب كليهما بالتسلسل (كما هو)

### ب. فحص صحيح لحالة الأذونات
- الموقع: استخدام `Geolocator.checkPermission()` الفعلي، وليس `hasLocation`
- الإشعارات: استخدام `Permission.notification.status`

### ج. عدم إعادة طلب الموقع تلقائياً
- تخزين `locationSkippedInOnboarding` عند إكمال Onboarding بدون منح الموقع
- في `LocationService.init()`: إذا كان الموقع مرفوضاً وتم تخطيه، لا استدعاء `getCurrentLocation()`

### د. إصلاح زر "استخدم موقع الجهاز"
- إظهار feedback فوري عند البدء (مثلاً تحديث نص "جاري تحديد الموقع...")
- معالجة الأخطاء وعرض رسالة واضحة عند الفشل
- التأكد من أن الـ binding والـ controller يعملان بشكل صحيح

---

## 3. منطق ذكي: لا نطلب الموقع مرة ثانية إذا المستخدم مكة

| الحالة | الإجراء |
|--------|---------|
| المستخدم منح الموقع | ✅ عرض "ممنوح" — لا نطلب |
| المستخدم رفض واختار مكة | ✅ لا نطلب تلقائياً في init |
| المستخدم فتح "اختر المدينة" وضغط "استخدم موقع الجهاز" | نطلب (إجراء صريح من المستخدم) |
