# خطة أصوات الصلاة والإشعارات

## نظرة عامة

هذه الوثيقة تغطي:
1. **الأصوات الجديدة**: 4 صوتيات اقتراب (قبل الأذان بـ X دقيقة) + تكبير قصير (عند وقت الصلاة مباشرة)
2. **إعدادات المستخدم**: توقيت الاقتراب، اختيار الصوت
3. **وحة الأدمن**: إدارة الأصوات (إضافة، حذف، تعديل)
4. **سؤال تقني حرج**: هل يعمل عند إطفاء التلفون أو إغلاق التطبيق؟

---

## هل التطبيق يجب أن يكون مفتوحاً؟

### الإجابة المختصرة: **لا للتنبيهات، نعم للأذان الكامل داخل التطبيق**

| نوع الصوت | متى يعمل؟ | هل يحتاج التطبيق مفتوح؟ |
|-----------|-----------|--------------------------|
| **إشعار مع صوت (Local Notification)** | وقت محدد مجدول من النظام | **لا** — يعمل حتى لو التلفون مقفل أو التطبيق مغلق |
| **تشغيل صوت داخل التطبيق (audioplayers)** | عند فتح التطبيق فقط | **نعم** — يحتاج التطبيق في الواجهة الأمامية |

### الشرح التقني

1. **Local Notifications (flutter_local_notifications)**  
   - تُجدول من التطبيق مسبقاً (مثلاً: "اعرض إشعاراً الساعة 12:15")  
   - النظام (Android/iOS) ينفذها في الوقت المحدد حتى لو التطبيق مغلق  
   - الصوت يُشغّل عبر قناة الإشعارات (`notification channel`)  
   - **الخلاصة:** تنبيهات اقتراب الصلاة + التكبير وقت الصلاة → تعمل بدون فتح التطبيق

2. **AudioService (audioplayers)**  
   - يشغّل ملفات من `assets` أو `res/raw` داخل التطبيق  
   - يعمل فقط عندما التطبيق يعمل (foreground)  
   - **الخلاصة:** لو تريد أذان كامل طويل داخل التطبيق → يحتاج التطبيق مفتوحاً

### توصية للميزة الجديدة

- **صوتية الاقتراب (قبل الأذان بـ X دقيقة)**: إشعار محلي مع صوت مخصص → يعمل بدون فتح التطبيق
- **التكبير عند الصلاة**: إشعار محلي مع صوت تكبير قصير → يعمل بدون فتح التطبيق
- **باقي الخيارات**: أذان كامل (اختياري) داخل التطبيق عند فتحه فقط

---

## البنية الحالية (قبل التعديل)

| المكوّن | الوظيفة | الملف |
|---------|---------|-------|
| `AudioService` | تشغيل أذان من `assets/sounds/athan.mp3` عند فتح التطبيق | `lib/core/services/audio_service.dart` |
| `LiveContextService` | يستدعي `playAdhan()` عندما يكون التطبيق مفتوحاً ودخل وقت الصلاة | `lib/features/prayer/data/services/live_context_service.dart` |
| `NotificationService` | جدولة إشعارات عند وقت الصلاة + تذكير بعد 30 دقيقة | `lib/features/prayer/data/services/notification_service.dart` |
| قناة `prayer_adhan` | تستخدم `RawResourceAndroidNotificationSound('athan')` → تحتاج `android/res/raw/athan.*` | `notification_service.dart` |
| `NotificationSoundMode` | adhan / vibrate / silent | `lib/core/constants/enums.dart` |

### الموارد الحالية

- `assets/sounds/`: للملفات المستخدمة بـ `audioplayers`
- `android/app/src/main/res/raw/`: لأصوات إشعارات أندرويد (مثل `athan.mp3`)

---

## نموذج الميزة الجديدة

### الأصوات

| النوع | الوصف | التوقيت |
|-------|-------|---------|
| **اقتراب الصلاة** | 4 صوتيات قصيرة مختلفة | قبل الأذان بـ X دقيقة (قابل للتعديل، افتراضي 15 دقيقة) |
| **التكبير** | صوت تكبير قصير (ليس أذاناً كاملاً) | عند دخول وقت الصلاة مباشرة |

### إعدادات المستخدم

| الإعداد | الوصف | القيم المقترحة |
|---------|-------|----------------|
| تفعيل تنبيه الاقتراب | تشغيل صوت الاقتراب أم لا | نعم / لا |
| دقائق قبل الأذان | كم دقيقة قبل وقت الصلاة تُشغّل صوتية الاقتراب | 5، 10، 15، 20، 30 (قابلة للتوسع) |
| صوت الاقتراب | أي من الـ 4 صوتيات | 1، 2، 3، 4 |
| تفعيل التكبير | تشغيل التكبير عند الصلاة أم لا | نعم / لا |
| وضع الصوت العام | adhan / vibrate / silent (للإشعارات) | كما هو حالياً |

---

## خطة التنفيذ

### المرحلة 1: البنية التحتية للأصوات

#### 1.1 أسماء الملفات والأماكن

افترض أنك أضفت في `assets/sounds/`:
- `approach_1.mp3`, `approach_2.mp3`, `approach_3.mp3`, `approach_4.mp3`
- `takbeer.mp3`

**Android:** إشعارات أندرويد تحتاج الملفات في `res/raw/` بأسماء بدون مسافات وحروف صغيرة. مثلاً:
- `res/raw/approach_1.mp3`, `approach_2.mp3`, ...
- `res/raw/takbeer.mp3`

**pubspec.yaml:**
```yaml
flutter:
  assets:
    - assets/sounds/
```

#### 1.2 مفتاح التخزين الجديد

```dart
// storage_keys.dart
static const String approachingAlertMinutes = 'approaching_alert_minutes';  // 5, 10, 15, 20, 30
static const String approachingAlertEnabled = 'approaching_alert_enabled';
static const String approachingSoundIndex = 'approaching_sound_index';     // 0-3
static const String takbeerAtPrayerEnabled = 'takbeer_at_prayer_enabled';
```

#### 1.3 Enum للأصوات

```dart
// إما enum أو استخدام index 0-3 للاقتراب
enum PrayerSoundType { approach1, approach2, approach3, approach4, takbeer }
```

---

### المرحلة 2: قنوات الإشعارات والجدولة

#### 2.1 قنوات جديدة في NotificationService

- **قناة اقتراب الصلاة** (`prayer_approaching`): صوت قصير
- **قناة التكبير** (`prayer_takbeer`): صوت تكبير

كل قناة تحتاج:
- `AndroidNotificationChannel` مع `RawResourceAndroidNotificationSound(...)`
- ربطها بإعدادات المستخدم (تفعيل/إيقاف)

#### 2.2 جدولة الإشعارات

**الوضع الحالي:**
- إشعار عند وقت الصلاة (adhan)
- إشعار تذكير بعد 30 دقيقة

**الوضع الجديد:**
- إشعار اقتراب: قبل وقت الصلاة بـ X دقيقة (من إعدادات المستخدم)
- إشعار تكبير: عند وقت الصلاة مباشرة (بدل أو بالإضافة للأذان حسب التصميم)
- إشعار تذكير: كما هو (بعد 30 دقيقة)

**Ids مقترحة:**
- اقتراب: 1001, 1002, 1003, 1004, 1005 (لكل صلاة)
- تكبير: 1, 2, 3, 4, 5 (كما هو حالياً أو حسب التصميم)
- تذكير: 101, 102, ... (كما هو)

يجب تحديث `rescheduleAllForToday()` و `schedulePrayerNotificationWithActions()` لجدولة إشعار الاقتراب والتكبير بناءً على الإعدادات.

---

### المرحلة 3: واجهة المستخدم

#### 3.1 الشاشة / القسم في الإعدادات

- قسم "أصوات الصلاة" أو "تنبيهات الصلاة" يشمل:
  - تفعيل تنبيه الاقتراب
  - اختيار الدقائق قبل الأذان (5، 10، 15، 20، 30)
  - اختيار صوت الاقتراب (قائمة أو أزرار مع معاينة)
  - تفعيل التكبير عند الصلاة
  - تفعيل/إيقاف الأذان الكامل (اختياري، للاستخدام داخل التطبيق فقط)

#### 3.2 معاينة الصوت

- زر "استمع" بجانب كل صوت
- يستخدم `AudioService` أو `audioplayers` مباشرة لعرض التجربة قبل الحفظ

---

### المرحلة 4: وحة الأدمن

#### 4.1 نموذج البيانات

**Firestore:** مجموعة `app_config` أو وثيقة `sounds` تحت `app_config`:

```
app_config/sounds
  - approachingSounds: [
      { id: 'approach_1', nameAr: 'صوت 1', nameEn: 'Sound 1', fileUrl: '...', enabled: true, order: 0 },
      ...
    ]
  - takbeerSounds: [
      { id: 'takbeer', nameAr: 'تكبير', nameEn: 'Takbeer', fileUrl: '...', enabled: true },
    ]
  - defaultApproachingMinutes: 15
  - lastUpdated: timestamp
  - updatedBy: adminUserId
```

**أو تبسيط:**
- الأصوات تُحزم داخل التطبيق (bundled)
- الأدمن يتحكم فقط في: تفعيل/إيقاف كل صوت، ترتيب عرضها، القيم الافتراضية
- لا حاجة لرفع ملفات جديدة عبر الأدمن في المرحلة الأولى

#### 4.2 الصلاحيات

- `AdminPermissions.editAppConfig` أو صلاحية جديدة مثل `manageSounds`
- الأدوار التي لها صلاحية التعديل: `superAdmin`, `admin`

#### 4.3 واجهة الأدمن (ويب أو Flutter Admin)

- عرض قائمة الأصوات (اقتراب + تكبير)
- تفعيل/إيقاف كل صوت
- ترتيب أصوات الاقتراب
- (اختياري) رفع أصوات جديدة عبر Firebase Storage وربطها بـ `fileUrl`

---

### المرحلة 5: مزامنة إعدادات الأدمن مع التطبيق

- عند فتح التطبيق أو تغيير الإعدادات:
  - جلب `app_config/sounds` من Firestore
  - المقارنة مع النسخة المحلية
  - تحديث قائمة الأصوات المتاحة
  - الاحتفاظ بإعدادات المستخدم المحلية (اختيار الصوت، الدقائق، التفويج)

---

## ملخص الملفات المتأثرة

| الملف | التعديل |
|-------|---------|
| `lib/core/constants/storage_keys.dart` | إضافة مفاتيح الإعدادات الجديدة |
| `lib/core/constants/enums.dart` | إضافة/تعديل enums الأصوات إن لزم |
| `lib/core/services/audio_service.dart` | دعم تشغيل أصوات الاقتراب والتكبير للمعاينة |
| `lib/features/prayer/data/services/notification_service.dart` | قنوات جديدة، جدولة اقتراب وتكبير |
| `lib/features/prayer/data/services/smart_notification_service.dart` | توافق مع النظام الجديد إن كان يُستخدم للصلاة |
| `lib/features/settings/controller/settings_controller.dart` | إعدادات الاقتراب والتكبير |
| `lib/features/settings/presentation/screens/settings_screen.dart` | واجهة إعدادات الأصوات |
| `lib/core/services/storage_service.dart` | قراءة/كتابة الإعدادات الجديدة |
| `lib/core/localization/ar_translations.dart` | ترجمات جديدة |
| `lib/core/localization/en_translations.dart` | ترجمات جديدة |
| `android/app/src/main/res/raw/` | إضافة ملفات الصوت للأندرويد |
| `pubspec.yaml` | التأكد من تضمين `assets/sounds/` |

---

## خيارات للأدمن (مراحل لاحقة)

### الخيار أ: إدارة بسيطة (مستوى 1)
- الأصوات مدمجة في التطبيق
- الأدمن يفعّل/يعطّل ويرتب الأصوات عبر Firestore
- التطبيق يحمل القائمة ويتجاهل المعطّلة

### الخيار ب: رفع أصوات من الأدمن (مستوى 2)
- الأدمن يرفع ملفات صوت عبر لوحة إدارية
- التخزين: Firebase Storage
- التطبيق يحمّل ويخزن محلياً للمرة الأولى
- يتطلب منطق تحميل وتخزين مؤقت

### الخيار ج: مزيج
- أصوات افتراضية مدمجة
- إمكانية إضافة أصوات جديدة من الأدمن
- التطبيق يفضّل المدمجة، ويتحقق من التحديثات في Firestore/Storage

---

## توصيات

1. **البداية:** تنفيذ الخيار أ (أصوات مدمجة + إدارة تفعيل/ترتيب من الأدمن).
2. **التجربة:** التأكد أن إشعارات الاقتراب والتكبير تعمل مع التطبيق مغلق والتلفون مقفل.
3. **الأندرويد:** وضع كل الأصوات في `res/raw/` مع أسماء مناسبة.
4. **iOS:** التحقق من دعم أصوات مخصصة في الإشعارات (قد تحتاج إضافة الملفات في مشروع iOS أيضاً).
5. **Battery optimization:** مراجعة إعدادات توفير البطارية على أندرويد حتى لا تُقتل الإشعارات المجدولة.

---

## ملخص الإجابة عن "هل التلفون يلزم يكون شغال؟"

- **التلفون يلزم يكون مُشغّل** (لا يعمل إذا كان مُطفأ).
- **التطبيق لا يلزم يكون مفتوحاً** — الإشعارات المجدولة تعمل حتى لو التطبيق مغلق أو التلفون مقفل.
- **صوت الأذان الطويل داخل التطبيق** يعمل فقط عند فتح التطبيق.

---

## ملفات الأصوات (تم التحديث)

### assets/sounds/
- fagrsoon.mp3, zohrsoon.mp3, asrsoon.mp3, maghribsoon.mp3, eshaasoon.mp3 (صوت اقتراب كل صلاة)
- Takbir 1.mp3 (تكبير عند وقت الصلاة — بدون أذان كامل)

### android/app/src/main/res/raw/
نسخت الملفات تلقائياً. المطلوب: أسماء بدون مسافات (takbir_1.mp3 بدل Takbir 1.mp3)
