# خطة التطوير المتكاملة – قُرب Qurb

## الهدف
استغلال كل البنية التحتية الموجودة (Services, Repositories, Models) وجعل التطبيق **حي (Live)** مع تركيز خاص على **صفحة العائلة** كنواة للتجربة الاجتماعية.

---

## 1) جرد البنية الحالية (ما مُنفَّذ وما غير مستغل)

### خدمات مُنفَّذة ومستغلة
| الخدمة | الاستخدام الحالي |
|--------|-------------------|
| `NotificationService` | أذان + تذكير +30، إلغاء بعد التسجيل، قنوات صوتية |
| `PrayerTimeService` | مواقيت اليوم، القبلة، التخزين المؤقت |
| `LiveContextService` | السياق الحي (صلاة حالية/قادمة، ملخص اليوم)، مرتبط بالـ Dashboard |
| `FamilyService` | إنشاء/انضمام عائلة، أعضاء، تسجيل صلاة عن طفل، تشجيع |
| `PrayerRepository` | تسجيل صلاة، تيار اليوم، أوفلاين + sync |
| `DatabaseHelper` | SQLite (prayer_logs, cached_family, sync_queue, …) |
| `SyncService` | حالة الـ sync، Worker عند عودة النت |
| `AuthService`, `StorageService`, `LocationService` | مستخدمة في كل التطبيق |

### خدمات/ملفات جاهزة لكن غير مستغلة بالكامل
| الملف/الخدمة | الإمكانيات | كيف نستغلها |
|--------------|------------|-------------|
| `SmartNotificationService` | أزرار إشعار (صليت، تذكير 5 دقائق، فاتتني) | دمج منطق الأزرار في `NotificationService` واستخدام جدولة واحدة موحدة |
| `notification_models.dart` | `NotificationActionType`, `DefaultNotificationActions`, `UserPrayerPattern` | استخدام الأنواع عند معالجة الضغط على الأزرار؛ لاحقاً نماذج ذكية للتذكير |
| `ApiConstants` | `feedItemsCollection`, `groupFeedSubcollection`, `userPatternsCollection` | Pulse العائلة على `group_feed` أو subcollection `pulse` تحت العائلة |
| `FamilyActivityModel` (إن وُجد) | نشاط العائلة | ربطه بتيار Pulse وعرضه في واجهة العائلة |
| إعدادات الإشعار (صوت أذان / اهتزاز / صامت) | موجودة في `NotificationService` و Storage | مكشوفة في الإعدادات ومرتبطة بجدولة الإشعارات |

### ميزات مطلوبة لـ "Live" ولم تُنفَّذ بعد
- **إشعار بأزرار فعلية**: زر "✅ صليت" يسجّل الصلاة فوراً (حتى بدون فتح التطبيق عند الإمكان)، وزر "⏰ لاحقاً" يؤجل التذكير.
- **Pulse العائلة**: تيار حي لأحداث العائلة (من صلى، من شجّع، إنجاز يومي) وعرضها في صفحة العائلة.
- **تحديث فوري لصفحة العائلة**: عند تسجيل أي عضو لصلاة، تحديث حالة "اليوم" (مثلاً 3/5) وربما إشعار "فلان صلى العصر".

---

## 2) خارطة الطريق (أولويات)

### المرحلة أ – إشعارات قابلة للإجراء (Actionable Notifications)
1. إضافة أزرار إلى إشعار الأذان والتذكير: **✅ صليت** و **⏰ لاحقاً**.
2. عند الضغط على "صليت": تسجيل الصلاة عبر `PrayerRepository.addPrayerLog`، إلغاء إشعار الأذان والتذكير لهذه الصلاة، وتحديث الـ LiveContext إن وُجد.
3. عند الضغط على "لاحقاً": جدولة تذكير جديد بعد 10 دقائق بنفس الصلاة (أو إظهار إشعار فوري "تذكير: صلاة X" بعد 10 دقائق).
4. التعامل مع حالة فتح التطبيق من الإشعار: عند الفتح من الإشعار، الانتقال للـ Dashboard ومعالجة الـ pending log إن وُجد (من Storage).

### المرحلة ب – Pulse العائلة (تيار حي)
1. **Firestore**: إنشاء subcollection (مثلاً `families/{familyId}/pulse`) أو استخدام `group_feed` مع حقول: `type` (prayer_logged, encouragement, daily_complete), `userId`, `userName`, `prayer`, `timestamp`, `metadata`.
2. **كتابة حدث عند التسجيل**: عند استدعاء `FamilyService.logPrayerForMember` أو عند تسجيل المستخدم لصلاته، كتابة حدث في Pulse (من الـ backend أو من التطبيق حسب البنية الحالية).
3. **PulseRepository أو توسيع FamilyService**: دالة/Stream تقرأ آخر N أحداث من Pulse مرتبة بـ `timestamp`.
4. **واجهة صفحة العائلة**: قسم "نبض العائلة" أو "آخر النشاط" يعرض آخر 10–20 حدثاً (من صلى ماذا، من شجّع من).

### المرحلة ج – صفحة العائلة كـ "لب التطبيق"
1. **بطاقة ملخص اليوم للعائلة**: عدد من صلّى من أصل 5 صلوات (مثلاً 3/5 للعائلة) مع progress bar أو دوائر صغيرة لكل صلاة.
2. **قائمة الأعضاء مع حالة اليوم**: لكل عضو عرض 2/5 أو 3/5 مع لون (أخضر/أصفر/أحمر) وزر "شجّعه" و"سجّل عنه" (للأب).
3. **قسم Pulse في أعلى أو وسط الصفحة**: أحداث حية مع وقت نسبي ("منذ 5 دقائق").
4. **إشعارات عائلية**: عند تفعيل الخيار، إشعار "فلان صلى العصر" (اختياري، يمكن تأجيله لمرحلة لاحقة).

### المرحلة د – استغلال إضافي للبنية
- **UserPrayerPattern / Smart Reminders**: استخدام `user_patterns` (إن وُجدت) لتخصيص وقت التذكير حسب عادة المستخدم (مثلاً تذكير بعد 20 دقيقة بدل 30).
- **الإعدادات**: ربط كل خيارات الإشعار (أذان، تذكير، عائلة، وضع الصوت) بواجهة الإعدادات وتخزينها في Storage واستخدامها في `NotificationService` و `DashboardController._scheduleNotifications`.

---

## 3) الاعتماديات بين المهام

```
Actionable Notifications (أ)
         ↓
   LiveContext + Dashboard يحدّثان بعد التسجيل من الإشعار

Family Pulse (ب)
         ↓
   صفحة العائلة (ج) تعرض Pulse + ملخص اليوم + أعضاء

الإعدادات والإشعارات الذكية (د) يمكن تنفيذها بالتوازي أو لاحقاً.
```

---

## 4) ملخص تنفيذي

- **الآن (تم أو قيد التنفيذ)**: إشعارات ذكية (لا تذكير إذا صُلّيت)، إلغاء إشعار بعد التسجيل، LiveContext، تحسين قاعدة البيانات.
- **تم تنفيذه**: أزرار إشعار "✅ صليت" و"⏰ لاحقاً" في إشعارات الأذان والتذكير؛ معالجة الضغط (تسجيل الصلاة أو تأجيل التذكير 10 دقائق)؛ Family Pulse (مجموعة `pulse` تحت `families/{id}`، تيار حي، قسم "نبض العائلة" في صفحة العائلة).
- **التالي**: تجميل وتنظيم صفحة العائلة (بطاقة ملخص اليوم للعائلة، ألوان أوضح)، وإشعارات عائلية (فلان صلى)، واستغلال UserPrayerPattern للتذكير الذكي.

**ملاحظة Firestore:** عند أول استخدام لـ Pulse، قد يطلب Firestore إنشاء فهرس مركّب على `families/{familyId}/pulse` (orderBy `timestamp` descending). استخدم الرابط الذي يظهر في رسالة الخطأ لإنشاء الفهرس من وحدة تحكم Firebase.
