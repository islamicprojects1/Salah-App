# نقد Antigravity — مواصفة العائلة والمجموعات

> تقييم قاسٍ لا يعتمد على مجاملة. الثغرات، السيناريوهات الحدية، والحلول المقترحة.

---

## 1. المشكلات المحتملة — هل الوثيقة عالجتها؟

### 1.1 إدارة المجموعة والمدير

| المشكلة | مُعالَجة؟ | الحل المقترح |
|---------|----------|--------------|
| **المدير حذف التطبيق أو توفي** | ❌ لا | إضافة آلية **نقل تلقائي للإدارة** بعد X شهراً من عدم نشاط المدير إلى أقدم عضو. أو خيار "تعيين مدير بديل" مسبقاً. المجموعة لا تموت بموت المدير. |
| **شخصان ادعيا أنهما مدير** | ❌ لا | الحقل `createdBy` في Firestore هو المرجع الوحيد. دور Admin يُحدَّد من قاعدة البيانات، لا من الادعاء. تأكيد: قاعدة واحدة فقط للمدير. |
| **المدير يريد التنحّي** | ⚠️ مذكور | "يختار عضواً آخر كمدير جديد" — لكن ماذا لو رفض العضو؟ الحل: إجبار اختيار مدير جديد قبل المغادرة، أو حل المجموعة كخيار صريح. |

### 1.2 الدعوة والانضمام

| المشكلة | مُعالَجة؟ | الحل المقترح |
|---------|----------|--------------|
| **الرابط أُرسل لآلاف الناس** | ❌ لا | الرابط/الكود **دائم** في الوثيقة — ثغرة أمنية. الحل: **خيار expiry** (24 ساعة، 7 أيام، دائم) حسب إعدادات المدير. أو **حد أقصى لعدد الاستخدامات** (مثلاً 50 انضماماً). |
| **شخص غير مرغوب انضم عبر الرابط** | ❌ لا | لا آلية طرد واضحة. الحل: المدير يطرد عضوًا → العضو يُحذف. هل يمكنه الانضمام مجدداً؟ الحل: **قائمة سوداء** (blocked users) على مستوى المجموعة — المدير يمنع إعادة الانضمام. |
| **الرابط قابل للتخمين؟** | ❌ لا | كود 6 أحرف = 36^6 احتمال — عملياً صعب. لكن لو كان 4 أحرف فهو ضعيف. الحل: 8 أحرف alphanumeric على الأقل، مع فحص unique في قاعدة البيانات. |
| **النت انقطع لحظة الانضمام** | ❌ لا | الانضمام عملية غير ذرية. الحل: **retry آلي**، وحالة "قيد الانضمام" محلياً، وواجهة "إكمال الانضمام" عند العودة. |

### 1.3 الأعضاء الظِل

| المشكلة | مُعالَجة؟ | الحل المقترح |
|---------|----------|--------------|
| **عضو ظِل كبر واشترى هاتفاً — كيف يصير فعلياً؟** | ❌ لا | الوثيقة صامتة. الحل: **ربط الظِل بالحساب** — عند تسجيل المستخدم الجديد، يطلب منه "هل أنت [اسم الظِل] في مجموعة [X]؟" إن وُجد تطابق (المدير يدخل بريد/رقم مسبقاً للظِل)، يُحوَّل الظِل لعضو فعلي ويُدمج سجله. |
| **المدير أضاف ابن ظِل مرتين** | ❌ لا | لا فحص تكرار. الحل: منع أسماء مكررة ضمن نفس المجموعة، أو إظهار تحذير "اسم موجود مسبقاً". |
| **اسم مسيء أو كاذب للظِل** | ❌ لا | لا تحقق. الحل: حد أقصى لطول الاسم، وربما تصفية كلمات مسيئة (قائمة أساسية). إبلاغ (report) من الأعضاء إن وُجد. |

### 1.4 المجموعات المتعددة والعضو الواحد

| المشكلة | مُعالَجة؟ | الحل المقترح |
|---------|----------|--------------|
| **عضو انضم لمجموعتين أو 10؟** | ❌ لا | الوثيقة تقول "مجموعة واحدة" — أي عضو في مجموعة واحدة فقط؟ أم لا حد؟ الحل: **تحديد سياسة صريحة** — إما مجموعة واحدة لكل مستخدم (الأبوى للعائلة)، أو متعددة مع حد (مثلاً 3–5). التعدد يحتاج واجهة "اختر المجموعة المعروضة". |
| **مجموعات متعددة لنفس المستخدم** | ⚠️ مرفوض ضمنياً | "نموذج مجموعة واحدة" — لكن المستخدم قد يريد: عائلتي + حلقة الشيخ + أصدقاء المسجد. الوثيقة ترفض ذلك بدون justification. الحل: السماح بـ 2–3 مجموعات كحد أقصى، مع تبويب أو اختيار "المجموعة النشطة". |

### 1.5 البيانات والنشاط

| المشكلة | مُعالَجة؟ | الحل المقترح |
|---------|----------|--------------|
| **المستخدم لم يفتح التطبيق منذ أشهر** | ❌ لا | هل يُطرد؟ هل بياناته تُحدَّث؟ الحل: **عدم الطرد التلقائي** — العضو يبقى. البيانات تُحدَّث عند الفتح. إشعار "لم يسجّل منذ X يوم" اختياري للعضو (للتذكير الذاتي). |
| **المجموعة وصلت 100 أو 1000 عضو** | ❌ لا | لا حد في الوثيقة. Firestore subcollection scale — عملياً يتحمل. لكن **قراءة X/Y** تحتاج عدّ صلوات كل عضو = N استعلامات أو تجميع. الحل: **تصميم مُحسَّن** — مثلاً daily aggregate document يُحدَّث عند كل صلاة، بدلاً من عدّ كل مرة. |
| **عضو ترك ثم عاد** | ❌ لا | هل يُقبل مجدداً؟ هل يحتفظ بتاريخه؟ الحل: **يُقبل مجدداً** بالرابط. السجل الشخصي يبقى (على المستخدم)، لكن **لا يُحسب في ملخص المجموعة** إلا بعد إعادة الانضمام**. التاريخ يُربط بالمستخدم لا بالم grupo membership. |

### 1.6 الحساب والهوية

| المشكلة | مُعالَجة؟ | الحل المقترح |
|---------|----------|--------------|
| **مستخدم جديد بدون حساب — ينضم قبل التسجيل؟** | ❌ لا | الرابط عادة يفتح التطبيق. إن لم يكن مسجلاً: الحل **إجبار التسجيل/تسجيل الدخول أولاً** ثم إكمال الانضمام. الرابط يُحفظ (pending invite) حتى يُكمل المستخدم. |
| **تغيير رقم الهاتف أو البريد** | ❌ لا | العضو في Firestore مرتبط بـ `userId` من Firebase Auth. تغيير البريد لا يغيّر الـ userId. لا مشكلة تقنياً — لكن وثّق ذلك. |
| **إعادة تثبيت التطبيق** | ❌ لا | العضوية في Firestore. عند تسجيل الدخول بنفس الحساب، يُجلب عضويته. لا مشكلة إن Sync صحيح. |
| **المستخدم حذف حسابه** | ❌ لا | الحل: عند حذف الحساب — **إزالته من كل المجموعات**، وتحديث X/Y. إن كان مديراً — تنفيذ آلية نقل الإدارة أو حل المجموعة. |

### 1.7 المجموعة الفارغة والطرد

| المشكلة | مُعالَجة؟ | الحل المقترح |
|---------|----------|--------------|
| **المجموعة فارغة (مدير فقط)** | ❌ لا | هل تُحذف؟ الوثيقة صامتة. الحل: **لا حذف تلقائي** — المدير قد يريد الإبقاء. لكن إظهار "ادعُ أعضاء" بشكل واضح. خيار "حل المجموعة" يدوياً من المدير. |
| **عضو طُرد — هل يعيد الانضمام بنفس الرابط؟** | ❌ لا | الحل: **نعم** — الرابط لا يتغيّر. لكن إن أضفناه للقائمة السوداء، نرفض انضمامه. |

---

## 2. الاختيارات التصميمية — هل هناك أفضل؟

### 2.1 الرابط فقط vs كود + رابط + QR

**المستخدم يفضّل الرابط فقط.**

| الجانب | الرابط فقط | كود + رابط + QR |
|--------|------------|-----------------|
| **لماذا الرابط أفضل؟** | مشاركة أسهل (نسخ/لصق، واتساب)، لا حاجة لطباعة QR، لا إدخال يدوي. يناسب 2025. | الكود يبقى مفيداً لمن لا يريد فتح روابط (paranoid)، والـ QR للقاءات الحضورية. |
| **عيوب الرابط وحده** | بدون نت: الرابط لا يفتح التطبيق إن كان غير مثبت. في لقاء حضوري: أسرع مسح QR من فتح رابط من ورقة. | — |
| **التوصية** | **الرابط كوسيلة أساسية** — الكود مشتق منه (نفس المعرف). الـ QR اختياري ويُولَّد من الرابط. المرحلة الأولى: رابط + كود للدخول اليدوي إن فشل deep link. |

**الثغرة في الوثيقة:** تضع الكود والرابط والـ QR بنفس الأهمية. الأفضل: **الرابط أساس**، والباقي تكميلي.

### 2.2 Drawer vs Navigation Bar (صفحة مستقلة)

**المستخدم يفضّل صفحة العائلة كـ tab مستقل في الـ Nav Bar.**

| الجانب | Drawer | Bottom Nav (صفحة مستقلة) |
|--------|--------|---------------------------|
| **إيجابيات** | لا يغيّر هيكل التطبيق، مكان لـ "ثانوي" | ظهور دائم، العائلة ميزة أساسية — وصول أسرع. |
| **سلبيات** | العائلة مخفية — تحتاج فتح القائمة أولاً. أقل اكتشافاً. | يحتاج إعادة هيكلة: إما IndexedStack مع تبويبين (الرئيسية + العائلة) أو BottomNav بـ 2–3 tabs. |
| **أنسب لتطبيق صلاة؟** | إن كانت العائلة "إضافية" — Drawer كافٍ. | إن كانت العائلة **جوهرية** (العائلة تصلي معاً) — **Bottom Nav أنسب** — المستخدم يفتح التطبيق ليرى نفسه وعائلته. |

**التوصية:** إن كان الربط العائلي جزءاً من القيمة الأساسية للتطبيق، **صفحة العائلة tab في Nav Bar** أفضل. الوثيقة اختارت Drawer بدون تبرير قوي — خيار المستخدم أوضح من ناحية القيمة.

### 2.3 مجموعة واحدة vs مجموعات متعددة

| الخيار | مزايا | عيوب |
|--------|-------|------|
| **واحدة** | بساطة، لا التباس | المستخدم العائلة + حلقة الشيخ + أصدقاء — مرفوض. |
| **متعددة (2–3)** | مرونة، يغطي سيناريوهات حقيقية | تعقيد واجهة (اختيار المجموعة)، وربما التكلفة. |

**التوصية:** السماح بـ **2–3 مجموعات كحد أقصى**، مع تبويب أو اختيار المجموعة النشطة. "مجموعة واحدة" قرار ضعيف بدون بحث مستخدمين.

### 2.4 ملخص X/Y فقط — هل كافٍ؟

الوثيقة: "بدون أسماء من صلّى ومن لم يصلّ".

**المشكلة:** بعض العائلات تريد معرفة **مَن صلّى** (بدون وقت) لتحفيز من لم يصلّ. مثال: "أحمد، محمد، فاطمة صلّوا — علي لم يسجّل بعد".

**التوصية:** إضافة **خيار تفعيل "أسماء من صلّوا"** (بدون وقت) كإعداد في المجموعة — يفعّله المدير. من يرفض يبقى invisible. الموازنة: خصوصية اختيارية مقابل تحفيز جماعي.

---

## 3. السيناريوهات الحدية — ملخص

| السيناريو | مُعالَج في الوثيقة؟ | الحل المقترح |
|-----------|---------------------|--------------|
| انضمام قبل التسجيل | ❌ | إجبار تسجيل الدخول، حفظ الرابط كـ pending حتى يُكمل. |
| تغيير البريد/الهاتف | ⚠️ | لا تأثير على العضوية (مرتبطة بـ userId). توثيق فقط. |
| إعادة تثبيت | ⚠️ | يعتمد على Sync — يجب ضمان جلب العضوية عند Login. |
| حذف الحساب | ❌ | إزالة من كل المجموعات + آلية نقل إدارة إن كان مديراً. |
| مجموعة فارغة | ❌ | لا حذف تلقائي؛ خيار "حل المجموعة" يدوياً. |
| عضو طُرد يعيد الانضمام | ❌ | مسموح ما لم يُضف للقائمة السوداء. |

---

## 4. الأمان والخصوصية

| المسألة | الوثيقة | الحل المقترح |
|---------|---------|--------------|
| **هل الرابط قابل للتخمين؟** | غير مذكور | 8+ أحرف alphanumeric عشوائي — كافٍ. تجنّب 4 أحرف. |
| **Expiry للرابط؟** | لا | خيار للمدير: دائم / 7 أيام / 24 ساعة. |
| **من يرى الأعضاء؟** | غير واضح | الأعضاء يرون قائمة الأسماء (للثقة). لا حاجة لإخفاء. |
| **إخفاء المدير لقائمة الأعضاء؟** | لا | غير مذكور. التوصية: لا إخفاء — الشفافية أساس الثقة. |
| **عضو يريد opt-out من الملخص** | لا | خيار "لا أظهر في ملخص المجموعة" — يحسب في Y لكن لا يساهم في X إن لم يصلّ. معقد. الأبسط: العضو يغادر إن أراد الخصوصية. |

---

## 5. هل يوجد تصميم أفضل؟

### 5.1 بدائل مقترحة

| البديل | الوصف | المزايا | العيوب |
|--------|-------|---------|--------|
| **Phone-number-based linking** | الربط برقم الهاتف (الأب يدخل أرقام الأبناء) | لا كود ولا رابط — الأب يضيف مباشرة | يحتاج إذن contacts أو إدخال يدوي. خصوصية. |
| **Username/handle** | كل مستخدم له username فريد. الأب يضيف @ahmed مثلاً | بسيط | يحتاج نظام username. قد لا يريده الجميع. |
| **Email invite** | دعوة بالبريد — الضغط يفتح التطبيق ويُكمل الانضمام | مألوف (Slack, Notion) | ليس الجميع يستخدم البريد يومياً. |

### 5.2 الحكم

النموذج الحالي (رابط/كود/QR) **منطقي ومعروف**. لكن الوثيقة تفتقد:
- آلية expiry أو حد استخدام للرابط.
- آلية نقل الإدارة التلقائية.
- سياسة صريحة للمجموعات المتعددة.
- معالجة انتقال الظِل إلى عضو فعلي.
- قائمة سوداء للطرد.

**التصميم ليس سيئاً — لكنه غير مكتمل.** التنفيذ دون معالجة هذه النقاط سيخلق مشكلات واضحة لاحقاً.

---

## 6. جدول ملخص: المشكلة | مُعالَجة؟ | الحل

| # | المشكلة | مُعالَجة؟ | الحل المقترح |
|---|---------|----------|--------------|
| 1 | المدير حذف التطبيق/توفي | ❌ | نقل تلقائي للإدارة بعد X شهر عدم نشاط، أو تعيين مدير بديل. |
| 2 | الرابط أُرسل لآلاف | ❌ | خيار expiry (24h/7d/dائم) و/أو حد استخدام. |
| 3 | شخص غير مرغوب انضم | ❌ | طرد + قائمة سوداء تمنع إعادة الانضمام. |
| 4 | الظِل يملك هاتفاً لاحقاً | ❌ | ربط الظِل بالحساب عند التسجيل (تطابق اسم + مجموعة). |
| 5 | ظِل مكرر أو اسم مسيء | ❌ | منع تكرار، حد طول، تصفية أساسية. |
| 6 | انقطاع النت عند الانضمام | ❌ | retry، حفظ حالة pending، إكمال عند العودة. |
| 7 | عضو في مجموعات متعددة؟ | ❌ | تحديد: مجموعة واحدة أو حد 2–3 مع واجهة اختيار. |
| 8 | مجموعة 100+ عضو | ❌ | تجميع يومي (daily aggregate) لملخص X/Y بدلاً من عدّ كل مرة. |
| 9 | عضو ترك ثم عاد | ❌ | مسموح. السجل الشخصي يُربط بالمستخدم. |
| 10 | انضمام قبل التسجيل | ❌ | إجبار تسجيل، حفظ pending invite. |
| 11 | حذف الحساب | ❌ | إزالة من المجموعات + نقل إدارة إن كان مديراً. |
| 12 | مجموعة فارغة | ❌ | لا حذف تلقائي؛ خيار "حل المجموعة" يدوياً. |
| 13 | الرابط قابل للتخمين؟ | ❌ | 8+ أحرف عشوائية، فحص unique. |
| 14 | Expiry للرابط | ❌ | خيار للمدير: دائم / 7 أيام / 24 ساعة. |
| 15 | Drawer vs Nav Bar | ⚠️ | توصية: Nav Bar tab إن كانت العائلة جوهرية. |
| 16 | الرابط فقط vs كود+QR | ⚠️ | الرابط أساس؛ الكود والـ QR تكميليان. |

---

## 7. الخلاصة النهائية

**الوثيقة جيدة كبداية** — الفلسفة والخصوصية والنموذج الموحّد منطقيان. لكنها **ليست جاهزة للتنفيذ** بدون:

1. معالجة **إدارة المدير** (موت، تنحّي، نقل).
2. سياسة **الرابط والدعوة** (expiry، حد استخدام، أمان).
3. آلية **الظِل → عضو فعلي**.
4. قرار صريح في **مجموعة واحدة vs متعددة**.
5. معالجة **الطرد وإعادة الانضمام** (قائمة سوداء).
6. قرار **وضع العائلة** — Drawer أم Nav Bar — بناءً على أولوية الميزة.
7. **أولوية الرابط** على الكود والـ QR كما يفضّل المستخدم.

**التقييم:** 6/10 — أساس سليم، تفاصيل ناقصة كثيرة. لا يُنفَّذ كما هي دون مراجعة.
