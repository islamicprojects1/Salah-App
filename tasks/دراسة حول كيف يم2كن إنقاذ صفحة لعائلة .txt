# وثيقة المواصفات الفنية: الذكاء الإيماني (Salah Intelligence Specification)

هذه الوثيقة تقدم دراسة معمقة للمنطق البرمجي (Logic) وهياكل البيانات (Data Structures) التي تجعل تطبيق "صلاة" نظاماً ذكياً متناغماً وناجحاً.

## 1. دراسة الجداول (Schema Study) والعلاقات المنطقية

تعتمد قوة النظام على الترابط الجغرافي والزمني والاجتماعي بين الجداول التالية:

### أ. جدول المستخدم (Users Collection)
*يركز على الهوية والوعي بالمحيط:*
- **التواجد المكاني (`lastLatitude`, `lastLongitude`)**: يسمح للنظام بتقديم "توصيات سياقية" مثل اقتراح أقرب مسجد عند اقتراب وقت الصلاة.
- **القوة الإيمانية (`currentStreak`, `totalPrayers`)**: بيانات تراكمية تسمح لـ "محرك الرؤى" بإنتاج رسائل تشجيعية واقعية.
- **رابط العائلة (`familyId`)**: المفتاح الذي يحول التجربة من فردية إلى جماعية.

### ب. جدول سجلات الصلاة (Prayer Logs Collection)
*يمثل "نبض الحياة" في التطبيق:*
- **جودة التوقيت (`timingQuality`)**: سجلات دقيقة (صلى مبكراً، في الوقت، متأخراً). هذا الحقل هو المحرك للـ **Heatmap** والـ **Insights**.
- **المنطق العلائقي (`addedByLeaderId`)**: يسمح بتوثيق "الصلاة الجماعية" التي يقودها الأب أو المعلم، مما يقوي الروابط الأسرية.

---

## 2. هندسة التناغم (Notification-Logic Harmony)

النجاح في تطبيقات Google يأتي من "التناغم"؛ أي أن الإشعار لا يزعجك بل يخدمك.

| الحدث (Trigger) | المنطق البرمجي (Logic) | الإشعار المتناغم (Harmonious Notification) |
| :--- | :--- | :--- |
| **دخول وقت الصلاة** | التأكد من موقع المستخدم (مكان عمل/منزل/مسجد). | تذكير صامت أو تنبيه بصوت الأذان حسب السياق. |
| **تسجيل الأب للصلاة** | فحص حالة الأبناء في نفس الـ `familyId`. | "والدك في المسجد الآن، هل تريد اللحاق به؟" |
| **تزامن صلاتين** | اكتشاف عضوين سجلا الصلاة خلال 15 دقيقة. | "ما أجمل صلاتكما معاً! [أ] و [ب] صليا في وقت متقارب." |
| **كسر الروتين** | المستخدم غائب عن التسجيل لـ 3 صلوات. | "تذكير رقيق: يبدو أنك منشغل اليوم، لا تنس وقتك مع الله." |

---

## 3. دراسة نسبة النجاح والواقعية (Success & Realism Study)

### لماذا هذا النظام ناجح وقوي؟
1.  **الواقعية (Realism)**: النظام لا يتوقع منك المثالية، بل يحلل نمط حياتك. إذا كنت تصلي الفجر عادة في الساعة 5:30، سيتدرب النظام على عدم إزعاجك في الساعة 5:00 بل يهنئك عند الساعة 5:30.
2.  **الربط المنطقي (Logical Linkage)**: البيانات لا تموت في الجداول؛ بل تتحول إلى **Insights** (رؤى). كل "صلاة" في الجدول تزيد من "زخم العائلة" البصري على الشاشة الرئيسية.
3.  **القوة (Strength)**: الاعتماد على الـ Firebase كقاعدة بيانات حية تجعل التحديثات بين أفراد العائلة فورية (Real-time)، مما يخلق شعوراً بالـ "التواجد الرقمي المستمر".

---

## 4. المسار التقني للتنفيذ (Implementation Roadmap)

1.  **المرحلة الأولى**: تحديث [LiveContextService](file:///c:/development/Salah-App/lib/core/services/live_context_service.dart#22-190) ليكون المحلل (Analytic Engine).
2.  **المرحلة الثانية**: تطوير واجهة "النبض الحي" (Live Pulse) التي تعرض العلاقة بين الأعضاء بشكل بصري وليس فقط كنص.
3.  **المرحلة الثالثة**: دمج الخريطة الحرارية (Heatmap) المتقدمة التي تقارن بين أداء الفرد وأداء العائلة ككل.
